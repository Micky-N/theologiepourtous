import{y as $,V as q,a0 as J,aS as G,aX as N,aY as z,aZ as w,a_ as V,r as b,o as M,an as B,c as P,ag as X,a$ as L,b0 as T,b1 as F,b2 as W,b3 as Z,z as H,e as Q,w as ee,X as ae,aw as te,n as re,G as R,aG as ne}from"#entry";function se(a){return a.validate&&a.__isYupSchema__}function ie(a){return a.inner!==void 0}function oe(a){return"schema"in a&&typeof a.coercer=="function"&&typeof a.validator=="function"&&typeof a.refiner=="function"}function le(a){return a.validateAsync!==void 0&&a.id!==void 0}function ue(a){return a.isJoi===!0}function ce(a){return"~standard"in a}async function de(a,n){const s=await n["~standard"].validate(a);return s.issues?{errors:s.issues?.map(r=>({name:r.path?.map(o=>typeof o=="object"?o.key:o).join(".")||"",message:r.message}))||[],result:null}:{errors:null,result:s.value}}async function fe(a,n){try{return{errors:null,result:await n.validate(a,{abortEarly:!1})}}catch(s){if(ie(s))return{errors:s.inner.map(o=>({name:o.path??"",message:o.message})),result:null};throw s}}async function me(a,n){const[s,r]=n.validate(a);return s?{errors:s.failures().map(S=>({message:S.message,name:S.path.join(".")})),result:null}:{errors:null,result:r}}async function pe(a,n){try{return{errors:null,result:await n.validateAsync(a,{abortEarly:!1})}}catch(s){if(ue(s))return{errors:s.details.map(o=>({name:o.path.join("."),message:o.message})),result:null};throw s}}function ye(a,n){if(ce(n))return de(a,n);if(le(n))return pe(a,n);if(se(n))return fe(a,n);if(oe(n))return me(a,n);throw new Error("Form validation failed: Unsupported form schema")}class g extends Error{formId;errors;children;constructor(n,s,r){super("Form validation exception"),this.formId=n,this.errors=s,this.children=r,Object.setPrototypeOf(this,g.prototype)}}const ve={base:""},we={__name:"UForm",props:{id:{type:[String,Number],required:!1},schema:{type:null,required:!1},state:{type:Object,required:!0},validate:{type:Function,required:!1},validateOn:{type:Array,required:!1,default(){return["input","blur","change"]}},disabled:{type:Boolean,required:!1},validateOnInputDelay:{type:Number,required:!1,default:300},transform:{type:null,required:!1,default:()=>!0},attach:{type:Boolean,required:!1,default:!0},loadingAuto:{type:Boolean,required:!1,default:!0},class:{type:null,required:!1},onSubmit:{type:Function,required:!1}},emits:["submit","error"],setup(a,{expose:n,emit:s}){const r=a,o=s,S=$(),U=q(()=>J({extend:J(ve),...S.ui?.form||{}})),c=r.id??G(),_=V(`form-${c}`),d=r.attach&&N(z,void 0);w(z,_);const x=b(new Map);M(async()=>{_.on(async e=>{e.type==="attach"?x.value.set(e.formId,{validate:e.validate}):e.type==="detach"?x.value.delete(e.formId):r.validateOn?.includes(e.type)&&!u.value&&(e.type!=="input"?await f({name:e.name,silent:!0,nested:!1}):(e.eager||O.has(e.name))&&await f({name:e.name,silent:!0,nested:!1})),e.type==="blur"&&O.add(e.name),(e.type==="change"||e.type==="input"||e.type==="blur"||e.type==="focus")&&C.add(e.name),(e.type==="change"||e.type==="input")&&I.add(e.name)})}),P(()=>{_.reset()}),M(async()=>{d&&(await X(),d.emit({type:"attach",validate:f,formId:c}))}),P(()=>{d&&d.emit({type:"detach",formId:c})});const i=b([]);w(L,i);const E=b({});w(T,E);const I=B(new Set),C=B(new Set),O=B(new Set);function A(e){return e.map(t=>({...t,id:t?.name?E.value[t.name]?.id:void 0}))}const K=b(null);async function Y(){let e=r.validate?await r.validate(r.state)??[]:[];if(r.schema){const{errors:t,result:l}=await ye(r.state,r.schema);t?e=e.concat(t):K.value=l}return A(e)}async function f(e={silent:!1,nested:!0,transform:!1}){const t=e.name&&!Array.isArray(e.name)?[e.name]:e.name,l=!t&&e.nested?Array.from(x.value.values()).map(({validate:m})=>m(e).then(()=>{}).catch(p=>{if(!(p instanceof g))throw p;return p})):[];if(t){const m=i.value.filter(y=>!t.some(v=>{const h=E.value?.[v]?.pattern;return v===y.name||h&&y.name?.match(h)})),p=(await Y()).filter(y=>t.some(v=>{const h=E.value?.[v]?.pattern;return v===y.name||h&&y.name?.match(h)}));i.value=m.concat(p)}else i.value=await Y();const j=(await Promise.all(l)).filter(m=>m!==void 0);if(i.value.length+j.length>0){if(e.silent)return!1;throw new g(c,i.value,j)}return e.transform&&Object.assign(r.state,K.value),r.state}const u=b(!1);w(W,F(u));async function k(e){u.value=r.loadingAuto&&!0;const t=e;try{t.data=await f({nested:!0,transform:r.transform}),await r.onSubmit?.(t),I.clear()}catch(l){if(!(l instanceof g))throw l;const j={...t,errors:l.errors,children:l.children};o("error",j)}finally{u.value=!1}}const D=q(()=>r.disabled||u.value);return w(Z,q(()=>({disabled:D.value,validateOnInputDelay:r.validateOnInputDelay}))),n({validate:f,errors:i,setErrors(e,t){t?i.value=i.value.filter(l=>t instanceof RegExp?!(l.name&&t.test(l.name)):l.name!==t).concat(A(e)):i.value=A(e)},async submit(){await k(new Event("submit"))},getErrors(e){return e?i.value.filter(t=>e instanceof RegExp?t.name&&e.test(t.name):t.name===e):i.value},clear(e){e?i.value=i.value.filter(t=>e instanceof RegExp?!(t.name&&e.test(t.name)):t.name!==e):i.value=[]},disabled:D,loading:u,dirty:q(()=>!!I.size),dirtyFields:F(I),blurredFields:F(O),touchedFields:F(C)}),(e,t)=>(Q(),H(ne(R(d)?"div":"form"),{id:R(c),class:re(U.value({class:r.class})),onSubmit:te(k,["prevent"])},{default:ee(()=>[ae(e.$slots,"default",{errors:i.value,loading:u.value})]),_:3},40,["id","class"]))}};export{we as _};
